#!/bin/bash
#
# Generate header with version information

ME=${0##*/}

[ $# -eq 1 ] || \
    { echo >&2 "Usage: $ME target-file"; exit 1; }
TARGET=$1
TMPFILE=$TARGET.$$.tmp

REPO_VERSION=$(git describe --tags --always --long --dirty)

# if built from jenkins/hudson, BUILD_TAG is set already
if [ -z "$BUILD_TAG" ]; then
        BUILD_TAG="manual build by \\\"$(git config --get user.name)\\\" <$(id -un)> on $(date +%F)"
fi

cat > "$TMPFILE" <<-EOF
        // automatically generated by $ME on $(date +%F) - do not edit
	#ifndef _GENERATED_VERSION_H
	#define _GENERATED_VERSION_H
	char const * const BUILDTAG = "${BUILD_TAG}";
	char const * const GITVERSION = "${REPO_VERSION}";
	#endif
EOF

# if nothing changed, we keep the old file
if cmp -s -- "$TARGET" "$TMPFILE"
then
    echo "nothing changed"
    rm -- "$TMPFILE"
else
    echo "new version $SCM_REVISION"
    mv -- "$TMPFILE" "$TARGET"
fi
